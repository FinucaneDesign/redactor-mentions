(function(){var e,t,n,s,i,r,o;i="undefined"!=typeof exports&&null!==exports?exports:this,e=i.jQuery,o=i.RedactorUtils=null!=(n=i.RedactorUtils)?n:{},t=i.RedactorPlugins=null!=(s=i.RedactorPlugins)?s:{},r=null,e.extend(o,function(){var t;return t=function(e){return e._ran=!1,e._return=null,function(){return e._ran||(e._ran=!0,e._return=e.apply(this,arguments)),e._return}},{once:t,any:function(e){var t,n,s;for(n=0,s=e.length;s>n;n++)if(t=e[n])return!0;return!1},deadLink:function(e){return e.preventDefault()},getCursorInfo:function(){var e,t;return t=window.getSelection(),e=t.getRangeAt(0),{selection:t,range:e,offset:e.startOffset,container:e.startContainer}},loadUsers:t(function(t){return e.getJSON(t,function(t){var n,s,i,o,u;for(r=t,o=[],n=s=0,i=t.length;i>s;n=++s)u=t[n],u.$element=e('<li class="user">\n    <img src="'+u.icon+'" />'+u.username+"  ("+u.name+")\n</li>"),o.push(u.$element[0].user=u);return o})}),filterTest:function(e,t){var n;return t=t.toLowerCase(),n=[e.username.toLowerCase(),e.name.toLowerCase()],o.any(n.map(function(e){return-1!==e.indexOf(t)}))},createMention:function(){var t,n,s,i,r;return t=o.getCursorInfo(),s=e('<a href="#" class="mention">@​</a>'),s.click(o.deadLink),n=t.container.data.slice(0,t.offset),r=t.container.data.slice(t.offset),n=n.slice(0,-1),t.container.data=n,s.insertAfter(t.container),s.after(r),i=document.createRange(),i.setStart(s[0].firstChild,1),i.setEnd(s[0].firstChild,1),t.selection.removeAllRanges(),t.selection.addRange(i)},cursorAfterMentionStart:function(){var e,t,n;return e=o.getCursorInfo(),"#text"!==e.container.nodeName?!1:(t=e.container.data.slice(0,e.offset),t=t.replace(/\u00a0/g," "),t=t.replace(/\u200b/g,""),"@"===(n=t.slice(-2))||" @"===n)}}}()),t.mentions=function(){return{init:function(){return this.mentions.select_state=null,this.mentions.selected=null,this.mentions.$userSelect=null,this.mentions.validateOptions(),o.loadUsers(this.opts.usersUrl),this.mentions.setupUserSelect(),this.mentions.setupEditor()},validateOptions:function(){var e,t,n,s,i;for(s=["usersUrl","maxUsers"],i=[],e=0,t=s.length;t>e;e++){if(n=s[e],!this.opts[n])throw"Mention plugin requires option: "+n;i.push(void 0)}return i},setupUserSelect:function(){return this.mentions.select_state=!1,this.mentions.$userSelect=e('<ol class="redactor_ user_select"></ol>'),this.mentions.$userSelect.hide(),this.mentions.$userSelect.mousemove(e.proxy(this.mentions.selectMousemove,this)),this.mentions.$userSelect.mousedown(e.proxy(this.mentions.selectMousedown,this)),this.$editor.after(this.mentions.$userSelect)},setupEditor:function(){return this.$editor.on("keydown.mentions",e.proxy(this.mentions.editorKeydown,this)),this.$editor.on("mousedown.mentions",e.proxy(this.mentions.editorKeydown,this))},selectMousemove:function(t){var n;return n=e(t.target),n.hasClass("user")?(this.mentions.selected=this.mentions.$userSelect.children().index(n),this.mentions.paintSelected()):void 0},selectMousedown:function(e){return this.mentions.select_state?(e.preventDefault(),this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect()):void 0},editorKeydown:function(t){var n,s;if(s=this,this.mentions.cursorInMention())switch(t.keyCode){case 27:this.mentions.closeMention(),this.mentions.disableSelect();break;case 9:case 13:t.preventDefault(),n=this.opts.tabFocus,this.opts.tabFocus=!1,this.mentions.select_state&&this.mentions.$userSelect.children().length>0&&this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect(),setTimeout(function(){return s.opts.tabFocus=n},0);break;case 38:t.preventDefault(),this.mentions.moveSelectUp();break;case 40:t.preventDefault(),this.mentions.moveSelectDown()}else o.cursorAfterMentionStart()&&(o.createMention(),this.mentions.enableSelect());return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},editorMousedown:function(){return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},updateSelect:function(){return this.mentions.cursorInMention()?(this.mentions.filterUsers(),this.mentions.$userSelect.show()):this.mentions.$userSelect.hide()},moveSelectUp:function(){return this.mentions.selected>0&&(this.mentions.selected-=1),this.mentions.paintSelected()},moveSelectDown:function(){return this.mentions.selected<this.mentions.$userSelect.children().length-1&&(this.mentions.selected+=1),this.mentions.paintSelected()},enableSelect:function(){var e,t,n;for(this.mentions.select_state=!0,this.mentions.selected=0,e=t=0,n=this.opts.maxUsers;n>=0?n>t:t>n;e=n>=0?++t:--t)this.mentions.$userSelect.append(r[e].$element);return this.mentions.paintSelected(),this.mentions.$userSelect.show()},disableSelect:function(){return this.mentions.select_state=!1,this.mentions.selected=null,this.mentions.$userSelect.children().detach(),this.mentions.$userSelect.hide()},paintSelected:function(){var t;return t=e("li",this.mentions.$userSelect),t.removeClass("selected"),t.eq(this.mentions.selected).addClass("selected")},chooseUser:function(){var e,t,n;return n=this.mentions.userFromSelected(),e=this.mentions.getCurrentMention(),t=this.opts.userUrlPrefix||"/user/",e.attr("href",t+n.username),e.text("@"+n.username)},userFromSelected:function(){return this.mentions.$userSelect.children("li")[this.mentions.selected].user},filterUsers:function(){var e,t,n,s,i;for(this.mentions.$userSelect.children().detach(),t=this.mentions.getFilterString(),e=0,n=0,s=r.length;s>n&&(i=r[n],!(e>=this.opts.maxUsers));n++)o.filterTest(i,t)&&(this.mentions.$userSelect.append(i.$element),e++);return this.mentions.paintSelected()},getFilterString:function(){var e,t;return t=this.mentions.getCurrentMention(),e=t.text(),e=e.slice(1),e=e.replace(/\u00a0/g," "),e.replace(/\u200b/g,"")},closeMention:function(){var e;return e=this.mentions.getCurrentMention(),e.attr("contenteditable","false")},getCurrentMention:function(){var t,n;if(t=e(this.selection.getCurrent()),t.hasClass("mention"))return t;if(n=t.parents(".mention"),n.length>0)return n.eq(0);throw"There is no current mention."},cursorInMention:function(){var e;try{this.mentions.getCurrentMention().length>0}catch(t){if(e=t,"There is no current mention."===e)return!1;throw e}return!0},setCursorAfterMention:function(){var e,t,n;return e=this.mentions.getCurrentMention(),e.after(" "),n=window.getSelection(),t=document.createRange(),t.setStart(e[0].nextSibling,1),t.setEnd(e[0].nextSibling,1),n.removeAllRanges(),n.addRange(t)}}}}).call(this);