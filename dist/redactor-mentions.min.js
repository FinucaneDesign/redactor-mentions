(function(){var e,t,n,i,s,o,r;s="undefined"!=typeof exports&&null!==exports?exports:this,e=s.jQuery,r=s.RedactorUtils=null!=(n=s.RedactorUtils)?n:{},t=s.RedactorPlugins=null!=(i=s.RedactorPlugins)?i:{},o=null,e.extend(r,function(){var t;return t=function(e){return e._ran=!1,e._return=null,function(){return e._ran||(e._ran=!0,e._return=e.apply(this,arguments)),e._return}},{once:t,any:function(e){var t,n,i;for(n=0,i=e.length;i>n;n++)if(t=e[n])return!0;return!1},deadLink:function(e){return e.preventDefault()},getCursorInfo:function(){var e,t;return t=window.getSelection(),e=t.getRangeAt(0),{selection:t,range:e,offset:e.startOffset,container:e.startContainer}},loadUsers:t(function(t){return e.getJSON(t,function(t){var n,i,s,r,c;for(o=t,r=[],n=i=0,s=t.length;s>i;n=++i)c=t[n],c.$element=e('<li class="user">\n    <img src="'+c.icon+'" />'+c.username+"  ("+c.name+")\n</li>"),r.push(c.$element[0].user=c);return r})}),filterTest:function(e,t){var n;return t=t.toLowerCase(),n=[e.username.toLowerCase(),e.name.toLowerCase()],r.any(n.map(function(e){return-1!==e.indexOf(t)}))},createMention:function(){var t,n,i,s,o;return t=r.getCursorInfo(),i=e('<a href="#" class="mention">@​</a>'),i.click(r.deadLink),n=t.container.data.slice(0,t.offset),o=t.container.data.slice(t.offset),n=n.slice(0,-1),t.container.data=n,i.insertAfter(t.container),i.after(o),s=document.createRange(),s.setStart(i[0].firstChild,1),s.setEnd(i[0].firstChild,1),t.selection.removeAllRanges(),t.selection.addRange(s)},cursorAfterMentionStart:function(){var e,t,n;return e=r.getCursorInfo(),"#text"!==e.container.nodeName?!1:(t=e.container.data.slice(0,e.offset),t=t.replace(/\u00a0/g," "),t=t.replace(/\u200b/g,""),"@"===(n=t.slice(-2))||" @"===n)}}}()),t.mentions=function(){return{init:function(){return this.mentions.select_state=null,this.mentions.selected=null,this.mentions.$userSelect=null,this.mentions.validateOptions(),r.loadUsers(this.opts.mentions.url),this.mentions.setupUserSelect(),this.mentions.setupEditor()},validateOptions:function(){var e,t,n,i,s;for(i=["url","maxUsers"],s=[],e=0,t=i.length;t>e;e++){if(n=i[e],!this.opts.mentions[n])throw"Mention plugin requires option: "+n;s.push(void 0)}return s},setupUserSelect:function(){return this.mentions.select_state=!1,this.mentions.$containerDiv=e('<div class="redactor-mentions-container"></div>'),this.mentions.$containerDiv.hide(),this.mentions.$userSelect=e('<ol class="redactor_ user-select"></ol>'),this.mentions.$containerDiv.append(this.mentions.$userSelect),this.mentions.$userSelect.mousemove(e.proxy(this.mentions.selectMousemove,this)),this.mentions.$userSelect.mousedown(e.proxy(this.mentions.selectClick,this)),this.$editor.after(this.mentions.$containerDiv)},setupEditor:function(){return this.$editor.on("keydown.mentions",e.proxy(this.mentions.editorKeydown,this)),this.$editor.on("mousedown.mentions",e.proxy(this.mentions.selectClick,this))},selectMousemove:function(t){var n;return n=e(t.target),n.hasClass("user")?(this.mentions.selected=this.mentions.$userSelect.children().index(n),this.mentions.paintSelected()):void 0},selectClick:function(e){return this.mentions.select_state?(e.preventDefault(),this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect()):void 0},editorKeydown:function(t){var n,i;if(i=this,this.mentions.cursorInMention())switch(t.which){case 27:this.mentions.closeMention(),this.mentions.disableSelect();break;case 9:case 13:t.preventDefault(),n=this.opts.tabFocus,this.opts.tabFocus=!1,this.mentions.select_state&&this.mentions.$userSelect.children().length>0&&this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect(),setTimeout(function(){return i.opts.tabFocus=n},0);break;case 38:t.preventDefault(),this.mentions.moveSelectUp();break;case 40:t.preventDefault(),this.mentions.moveSelectDown()}else r.cursorAfterMentionStart()&&(r.createMention(),this.mentions.enableSelect());return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},editorMousedown:function(){return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},positionContainerDiv:function(){var t,n,i;return t=e(this.selection.getNodes()[0]),n=this.$box.offset(),i=t.offset(),this.mentions.$containerDiv.css({left:i.left-n.left,top:i.top-n.top+parseFloat(t.css("line-height"))})},updateSelect:function(){return this.mentions.cursorInMention()?(this.mentions.filterUsers(),this.mentions.positionContainerDiv(),this.mentions.$containerDiv.show()):this.mentions.$containerDiv.hide()},moveSelectUp:function(){return this.mentions.selected>0&&(this.mentions.selected-=1),this.mentions.paintSelected()},moveSelectDown:function(){return this.mentions.selected<this.mentions.$userSelect.children().length-1&&(this.mentions.selected+=1),this.mentions.paintSelected()},enableSelect:function(){var e,t,n;for(this.mentions.select_state=!0,this.mentions.selected=0,e=t=0,n=this.opts.mentions.maxUsers;n>=0?n>t:t>n;e=n>=0?++t:--t)this.mentions.$userSelect.append(o[e].$element);return this.mentions.paintSelected(),this.mentions.positionContainerDiv(),this.mentions.$containerDiv.show()},disableSelect:function(){return this.mentions.select_state=!1,this.mentions.selected=null,this.mentions.$userSelect.children().detach(),this.mentions.$containerDiv.hide()},paintSelected:function(){var t;return t=e("li",this.mentions.$userSelect),t.removeClass("selected"),t.eq(this.mentions.selected).addClass("selected")},chooseUser:function(){var e,t,n;return n=this.mentions.userFromSelected(),e=this.mentions.getCurrentMention(),t=this.opts.mentions.urlPrefix||"/user/",e.attr("href",t+n.username),e.text("@"+n.username)},userFromSelected:function(){return this.mentions.$userSelect.children("li")[this.mentions.selected].user},filterUsers:function(){var e,t,n,i,s;for(this.mentions.$userSelect.children().detach(),t=this.mentions.getFilterString(),e=0,n=0,i=o.length;i>n&&(s=o[n],!(e>=this.opts.mentions.maxUsers));n++)r.filterTest(s,t)&&(this.mentions.$userSelect.append(s.$element),e++);return this.mentions.paintSelected()},getFilterString:function(){var e,t;return t=this.mentions.getCurrentMention(),e=t.text(),e=e.slice(1),e=e.replace(/\u00a0/g," "),e.replace(/\u200b/g,"")},closeMention:function(){var e;return e=this.mentions.getCurrentMention(),e.attr("contenteditable","false")},getCurrentMention:function(){var t,n;if(t=e(this.selection.getCurrent()),t.hasClass("mention"))return t;if(n=t.parents(".mention"),n.length>0)return n.eq(0);throw"There is no current mention."},cursorInMention:function(){var e;try{this.mentions.getCurrentMention().length>0}catch(t){if(e=t,"There is no current mention."===e)return!1;throw e}return!0},setCursorAfterMention:function(){var e,t,n;return e=this.mentions.getCurrentMention(),e.after(" "),n=window.getSelection(),t=document.createRange(),t.setStart(e[0].nextSibling,1),t.setEnd(e[0].nextSibling,1),n.removeAllRanges(),n.addRange(t)}}}}).call(this);