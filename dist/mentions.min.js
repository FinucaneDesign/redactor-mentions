var $,plugins,ref,ref1,root,users,utils;root="undefined"!=typeof exports&&null!==exports?exports:this,$=root.jQuery,utils=root.RedactorUtils=null!=(ref=root.RedactorUtils)?ref:{},plugins=root.RedactorPlugins=null!=(ref1=root.RedactorPlugins)?ref1:{},users=null,$.extend(utils,function(){var e;return e=function(e){return e._ran=!1,e._return=null,function(){return e._ran||(e._ran=!0,e._return=e.apply(this,arguments)),e._return}},{once:e,any:function(e){var t,s,r;for(s=0,r=e.length;r>s;s++)if(t=e[s])return!0;return!1},deadLink:function(e){return e.preventDefault()},getCursorInfo:function(){var e,t;return t=window.getSelection(),e=t.getRangeAt(0),{selection:t,range:e,offset:e.startOffset,container:e.startContainer}},loadUsers:e(function(e){return $.getJSON(e,function(e){var t,s,r,n,i;for(users=e,n=[],t=s=0,r=e.length;r>s;t=++s)i=e[t],i.$element=$('<li class="user">\n    <img src="'+i.icon+'" />'+i.username+"  ("+i.name+")\n</li>"),n.push(i.$element[0].user=i);return n})}),filterTest:function(e,t){var s;return t=t.toLowerCase(),s=[e.username.toLowerCase(),e.name.toLowerCase()],utils.any(s.map(function(e){return-1!==e.indexOf(t)}))},createMention:function(){var e,t,s,r,n;return e=utils.getCursorInfo(),s=$('<a href="#" class="mention">@​</a>'),s.click(utils.deadLink),t=e.container.data.slice(0,e.offset),n=e.container.data.slice(e.offset),t=t.slice(0,-1),e.container.data=t,s.insertAfter(e.container),s.after(n),r=document.createRange(),r.setStart(s[0].firstChild,1),r.setEnd(s[0].firstChild,1),e.selection.removeAllRanges(),e.selection.addRange(r)},cursorAfterMentionStart:function(){var e,t,s;return e=utils.getCursorInfo(),"#text"!==e.container.nodeName?!1:(t=e.container.data.slice(0,e.offset),t=t.replace(/\u00a0/g," "),t=t.replace(/\u200b/g,""),"@"===(s=t.slice(-2))||" @"===s)}}}()),$.extend(plugins,function(){return{mentions:{init:function(){return this.select_state=null,this.selected=null,this.$userSelect=null,this.validateOptions(),utils.loadUsers(this.opts.usersUrl),this.setupUserSelect(),this.setupEditor()},validateOptions:function(){var e,t,s,r,n;for(r=["usersUrl","maxUsers"],n=[],e=0,t=r.length;t>e;e++){if(s=r[e],!this.opts[s])throw"Mention plugin requires option: "+s;n.push(void 0)}return n},setupUserSelect:function(){return this.select_state=!1,this.$userSelect=$('<ol class="redactor_ user_select"></ol>'),this.$userSelect.hide(),this.$userSelect.mousemove($.proxy(this.selectMousemove,this)),this.$userSelect.mousedown($.proxy(this.selectMousedown,this)),this.$editor.after(this.$userSelect)},setupEditor:function(){return this.$editor.keydown($.proxy(this.editorKeydown,this)),this.$editor.mousedown($.proxy(this.editorMousedown,this))},selectMousemove:function(e){var t;return t=$(e.target),t.hasClass("user")?(this.selected=this.$userSelect.children().index(t),this.paintSelected()):void 0},selectMousedown:function(e){return this.select_state?(e.preventDefault(),this.chooseUser(),this.closeMention(),this.setCursorAfterMention(),this.disableSelect()):void 0},editorKeydown:function(e){var t,s;if(s=this,this.cursorInMention())switch(e.keyCode){case 27:this.closeMention(),this.disableSelect();break;case 9:case 13:e.preventDefault(),t=this.opts.tabFocus,this.opts.tabFocus=!1,this.select_state&&this.$userSelect.children().length>0&&this.chooseUser(),this.closeMention(),this.setCursorAfterMention(),this.disableSelect(),setTimeout(function(){return s.opts.tabFocus=t},0);break;case 38:e.preventDefault(),this.moveSelectUp();break;case 40:e.preventDefault(),this.moveSelectDown()}else utils.cursorAfterMentionStart()&&(utils.createMention(),this.enableSelect());return setTimeout($.proxy(this.updateSelect,this),0)},editorMousedown:function(){return setTimeout($.proxy(this.updateSelect,this),0)},updateSelect:function(){return this.cursorInMention()?(this.filterUsers(),this.$userSelect.show()):this.$userSelect.hide()},moveSelectUp:function(){return this.selected>0&&(this.selected-=1),this.paintSelected()},moveSelectDown:function(){return this.selected<this.$userSelect.children().length-1&&(this.selected+=1),this.paintSelected()},enableSelect:function(){var e,t,s;for(this.select_state=!0,this.selected=0,e=t=0,s=this.opts.maxUsers;s>=0?s>t:t>s;e=s>=0?++t:--t)this.$userSelect.append(users[e].$element);return this.paintSelected(),this.$userSelect.show()},disableSelect:function(){return this.select_state=!1,this.selected=null,this.$userSelect.children().detach(),this.$userSelect.hide()},paintSelected:function(){var e;return e=$("li",this.$userSelect),e.removeClass("selected"),e.eq(this.selected).addClass("selected")},chooseUser:function(){var e,t,s;return s=this.userFromSelected(),e=this.getCurrentMention(),t=this.opts.userUrlPrefix||"/user/",e.attr("href",t+s.username),e.text("@"+s.username)},userFromSelected:function(){return this.$userSelect.children("li")[this.selected].user},filterUsers:function(){var e,t,s,r,n;for(this.$userSelect.children().detach(),t=this.getFilterString(),e=0,s=0,r=users.length;r>s&&(n=users[s],!(e>=this.opts.maxUsers));s++)utils.filterTest(n,t)&&(this.$userSelect.append(n.$element),e++);return this.paintSelected()},getFilterString:function(){var e,t;return t=this.getCurrentMention(),e=t.text(),e=e.slice(1),e=e.replace(/\u00a0/g," "),e.replace(/\u200b/g,"")},closeMention:function(){var e;return e=this.getCurrentMention(),e.attr("contenteditable","false")},getCurrentMention:function(){var e,t;if(e=$(this.getCurrent()),e.hasClass("mention"))return e;if(t=e.parents(".mention"),t.length>0)return t.eq(0);throw"There is no current mention."},cursorInMention:function(){var e;try{this.getCurrentMention().length>0}catch(t){if(e=t,"There is no current mention."===e)return!1;throw e}return!0},setCursorAfterMention:function(){var e,t,s;return e=this.getCurrentMention(),e.after(" "),s=window.getSelection(),t=document.createRange(),t.setStart(e[0].nextSibling,1),t.setEnd(e[0].nextSibling,1),s.removeAllRanges(),s.addRange(t)}}}}());